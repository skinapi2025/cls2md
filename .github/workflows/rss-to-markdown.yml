name: RSS to Markdown

on:
  schedule:
    # 每6小时运行一次（UTC时间，可根据需要调整）
    - cron: '0 */6 * * *'
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install rss-parser
      run: npm install rss-parser
      
    - name: Fetch RSS and Convert to Markdown
      run: |
        node << 'EOF'
        const RSSParser = require('rss-parser');
        const fs = require('fs');
        const path = require('path');
        
        const parser = new RSSParser({
          customFields: {
            item: ['content:encoded', 'content', 'summary']
          }
        });
        
        // 配置您的RSS源
        const feeds = [
          {
            url: 'https://rss.injahow.cn/cls/telegraph',  // 财联社电报
            name: 'cls_telegraph',
            maxItems: 20
          }
          // 可以添加更多RSS源
          // { url: 'https://another.com/rss', name: 'source2', maxItems: 20 }
        ];
        
        const outputDir = './articles';
        if (!fs.existsSync(outputDir)) {
          fs.mkdirSync(outputDir, { recursive: true });
        }
        
        async function fetchFeed(feed) {
          try {
            // 清理URL，去除可能的末尾冒号
            const cleanUrl = feed.url.replace(/:$/, '');
            console.log(`Fetching: ${cleanUrl}`);
            
            let parsed;
            try {
              parsed = await parser.parseURL(cleanUrl);
            } catch (parseError) {
              console.error(`Parse error for ${cleanUrl}:`, parseError.message);
              const response = await fetch(cleanUrl);
              const xml = await response.text();
              if (xml.includes('<html') || xml.includes('<!DOCTYPE')) {
                throw new Error('Received HTML instead of RSS feed');
              }
              parsed = await parser.parseString(xml);
            }
            
            if (!parsed || !parsed.items || parsed.items.length === 0) {
              console.error(`No items found in ${cleanUrl}`);
              return { name: feed.name, count: 0, error: 'No items found' };
            }
            
            const items = parsed.items.slice(0, feed.maxItems);
            
            // 读取现有文件获取已有的ID
            const filepath = `${outputDir}/${feed.name}.md`;
            let existingIds = new Set();
            let existingContent = '';
            
            if (fs.existsSync(filepath)) {
              existingContent = fs.readFileSync(filepath, 'utf-8');
              const idMatches = existingContent.match(/article\/(\d+)/g) || [];
              existingIds = new Set(idMatches.map(m => m.split('/').pop()));
            }
            
            // 过滤掉已存在的文章
            const newItems = items.filter(item => {
              const idMatch = item.link.match(/article\/(\d+)/);
              const id = idMatch ? idMatch[1] : null;
              return id && !existingIds.has(id);
            });
            
            if (newItems.length === 0) {
              console.log(`No new items for ${feed.name}`);
              return { name: feed.name, count: 0 };
            }
            
            console.log(`Found ${newItems.length} new items for ${feed.name}`);
            
            // 构建新内容
            let newContent = '';
            newItems.forEach((item) => {
              // 转换时区 (UTC -> 北京时间 +8小时)
              const date = item.pubDate ? (() => {
                const d = new Date(item.pubDate);
                d.setHours(d.getHours() + 8);
                return d.toLocaleString('zh-CN');
              })() : '未知时间';
              
              const content = item['content:encoded'] || item.content || item.summary || item.contentSnippet || '';
              
              // 清理HTML标签
              let cleanContent = content
                .replace(/<script[^>]*>.*?<\/script>/gs, '')
                .replace(/<style[^>]*>.*?<\/style>/gs, '')
                .replace(/<[^>]+>/g, '\n')
                .replace(/\n{3,}/g, '\n\n')
                .trim();
              
              // 处理CDATA
              cleanContent = cleanContent.replace(/<!\[CDATA\[/g, '').replace(/\]\]>/g, '');
              
              // 获取分类
              const categories = item.categories ? item.categories.join(', ') : '';
              
              newContent += `## ${item.title}\n\n`;
              newContent += `**时间**: ${date}\n`;
              if (categories) {
                newContent += `**标签**: ${categories}\n`;
              }
              newContent += `\n${cleanContent}\n\n`;
              newContent += `[原文链接](${item.link})\n\n`;
              newContent += `---\n\n`;
            });
            
            // 追加到文件最前面
            if (existingContent) {
              existingContent = existingContent.replace(/\n---\n\n$/, '');
              newContent += existingContent;
            } else {
              newContent = `# ${parsed.title || feed.name}\n\n` + newContent.replace(/\n---\n\n$/, '');
            }
            
            fs.writeFileSync(filepath, newContent);
            console.log(`Saved: ${filepath} (${newItems.length} new items)`);
            
            return { name: feed.name, count: newItems.length };
          } catch (error) {
            console.error(`Error fetching ${feed.url}:`, error.message);
            return { name: feed.name, count: 0, error: error.message };
          }
        }
        
        async function main() {
          const results = await Promise.all(feeds.map(fetchFeed));
          console.log('\n=== 执行结果 ===');
          results.forEach(r => {
            if (r.error) {
              console.log(`❌ ${r.name}: 失败 - ${r.error}`);
            } else {
              console.log(`✅ ${r.name}: 成功导出 ${r.count} 条`);
            }
          });
        }
        
        main();
        EOF
        
    - name: Commit and Push
      run: |
        git config --local user.email "skinapi@gmail.com"
        git config --local user.name "skinapi"
        git add ./articles/
        git commit -m "Update RSS articles $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
        git push
